name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build python3 python3-pip clang iverilog verilator

          # Install a compatible LLVM+MLIR dev set. Try versioned packages first,
          # then fall back to unversioned names.
          for v in 19 18 17 16 15 ""; do
            if [[ -n "$v" ]]; then
              pkgs="llvm-${v}-dev mlir-${v}-tools libmlir-${v}-dev"
            else
              pkgs="llvm-dev mlir-tools libmlir-dev"
            fi
            if sudo apt-get install -y ${pkgs}; then
              break
            fi
          done

          (command -v llvm-config && llvm-config --version) || \
            (command -v llvm-config-19 && llvm-config-19 --version) || \
            (command -v llvm-config-18 && llvm-config-18 --version) || \
            (command -v llvm-config-17 && llvm-config-17 --version) || \
            (command -v llvm-config-16 && llvm-config-16 --version) || \
            (command -v llvm-config-15 && llvm-config-15 --version)

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          set -euxo pipefail
          brew update
          brew install ninja cmake llvm python@3 icarus-verilog verilator || brew install ninja cmake llvm icarus-verilog verilator
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: Configure
        run: |
          set -euxo pipefail
          LLVM_CONFIG="$(command -v llvm-config || true)"
          if [[ -z "${LLVM_CONFIG}" ]]; then
            LLVM_CONFIG="$(command -v llvm-config-19 || command -v llvm-config-18 || command -v llvm-config-17 || command -v llvm-config-16 || command -v llvm-config-15)"
          fi

          LLVM_DIR="$("${LLVM_CONFIG}" --cmakedir)"
          MLIR_DIR="$(dirname "$LLVM_DIR")/mlir"

          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_DIR="$LLVM_DIR" \
            -DMLIR_DIR="$MLIR_DIR" \
            -DPYC_BUILD_CPP_EXAMPLES=OFF

      - name: Build (pyc-compile / pyc-opt)
        run: |
          set -euxo pipefail
          ninja -C build pyc-compile pyc-opt

      - name: Regenerate local outputs (examples + janus)
        run: |
          set -euxo pipefail
          bash designs/examples/update_generated.sh
          bash designs/janus/update_generated.sh
          test -f .pycircuit_out/examples/counter/counter.v
          test -f .pycircuit_out/examples/calculator/calculator.v
          test -f .pycircuit_out/examples/digital_clock/digital_clock.v
          test -f .pycircuit_out/janus/janus_bcc_pyc/janus_bcc_pyc.v

      - name: Ensure generated artifacts are not tracked
        run: |
          set -euxo pipefail
          if git ls-files | grep -E '(^|/)generated/'; then
            echo "error: generated artifacts are tracked in git" >&2
            exit 1
          fi

      - name: Enforce frontend API hygiene
        run: |
          set -euxo pipefail
          python3 flows/tools/check_api_hygiene.py

      - name: Run Linx CPU C++ regression
        run: |
          set -euxo pipefail
          bash flows/tools/run_linx_cpu_pyc_cpp.sh

      - name: Run Janus C++ regressions
        run: |
          set -euxo pipefail
          bash designs/janus/tools/run_janus_bcc_pyc_cpp.sh
          bash designs/janus/tools/run_janus_bcc_ooo_pyc_cpp.sh

      - name: Perf smoke (Linx + Janus)
        run: |
          set -euxo pipefail
          python3 flows/tools/perf/run_perf_smoke.py \
            --profile release \
            --sim-mode cpp-only \
            --logic-depth 32 \
            --perf-repeats-linx 16 \
            --perf-repeats-janus 16 \
            --perf-max-cycles 4096 \
            --output .pycircuit_out/perf/perf_smoke.json
          python3 flows/tools/perf/check_perf_regression.py \
            --current .pycircuit_out/perf/perf_smoke.json \
            --baseline flows/tools/perf/baseline.json \
            --time-regression-pct 30 \
            --throughput-regression-pct 30

      - name: Run Verilog sims (open-source flow)
        run: |
          set -euxo pipefail
          python3 flows/tools/pyc_flow.py verilog-sim fastfwd_pyc +max_cycles=200 +max_pkts=400 +seed=1 +notrace +nolog
          python3 flows/tools/pyc_flow.py verilog-sim issue_queue_2picker +notrace +nolog
          python3 flows/tools/pyc_flow.py verilog-sim linx_cpu_pyc --tool verilator \
            +memh=designs/examples/linx_cpu/programs/test_or.memh +expected=0000ff00 +notrace +nolog

      - name: FastFwd cross-check (C++ vs Verilog)
        run: |
          set -euxo pipefail
          python3 flows/tools/pyc_flow.py fastfwd-crosscheck --tool iverilog --seed 1 --cycles 200 --packets 400
